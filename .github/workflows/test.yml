name: test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Use Node.js 22.x
        uses: actions/setup-node@v6
        with:
          node-version: 22.x
      - uses: pnpm/action-setup@v4.1.0
        with:
          version: 10.27.0
          run_install: false
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      - name: Setup pnpm cache
        uses: actions/cache@v5
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      - run: pnpm install --frozen-lockfile
      - name: TypeScript check
        run: pnpm tsc:check
      - name: Lint
        run: pnpm lint
      - name: Format check
        run: pnpm lint:format
      - name: Build
        run: pnpm build
      - name: Check bundle size
        run: |
          if [ -d "packages/web-api/public" ]; then
            # Total bundle size
            CLIENT_SIZE=$(du -sk packages/web-api/public | cut -f1)
            echo "CLIENT_SIZE=${CLIENT_SIZE}" >> $GITHUB_ENV
            
            echo ""
            echo "üì¶ Bundle Size Report"
            echo "====================="
            echo ""
            
            # Build JSON for PR comment using node for reliability
            BUNDLE_JSON=$(node -e "
              const fs = require('fs');
              const path = require('path');
              
              // Chunk size limits in KB (set generously above current sizes)
              const limits = {
                'index': 1100,           // main app bundle (reduced due to lazy loading)
                'vendor-react': 50,
                'vendor-pouchdb': 200,
                'vendor-ui': 100,
                'vendor-graph': 250,
                'vendor-markdown': 200,
                'vendor-query': 100,
                'vendor-utils': 100,
                'dynamic': 300,          // elkjs dynamic import
                'todo_graph': 100,       // lazy-loaded graph component
                'todo_board': 50,        // lazy-loaded kanban view
                'todo_board_state': 50,  // shared board state
                'todo_table': 60,        // lazy-loaded table view
                'chat_page': 200,        // lazy-loaded chat (assistant-ui)
                'chat_view': 10,         // chat view wrapper
                'subtasks_popover': 20,  // subtasks component
              };
              
              const assetsDir = 'packages/web-api/public/assets';
              const files = fs.readdirSync(assetsDir).filter(f => f.endsWith('.js'));
              
              const chunks = files.map(filename => {
                const filePath = path.join(assetsDir, filename);
                const stats = fs.statSync(filePath);
                const sizeKb = Math.round(stats.size / 1024);
                
                // Extract chunk name from filename patterns:
                // - vendor-react-JtTXGiG9.js ‚Üí vendor-react
                // - index-DqmYEbsX.js ‚Üí index  
                // - CDWEKZTF-CaGrxhYk.js ‚Üí dynamic (all caps = dynamic import)
                let name = filename
                  .replace(/\.js$/, '')              // remove extension
                  .replace(/-[A-Za-z0-9_]{6,}$/, ''); // remove final hash segment (may contain _)
                
                // Handle dynamic chunks (start with uppercase hash like CDWEKZTF)
                if (/^[A-Z0-9]{6,}/.test(name)) name = 'dynamic';
                const limit = limits[name] || 500;
                
                return { name, size: sizeKb, limit };
              });
              
              console.log(JSON.stringify({
                total: ${CLIENT_SIZE},
                totalLimit: 3500,
                chunks
              }));
            ")
            
            echo "BUNDLE_JSON=${BUNDLE_JSON}" >> $GITHUB_ENV
            
            # Display results
            node -e "
              const data = ${BUNDLE_JSON};
              let hasViolation = false;
              
              data.chunks
                .sort((a, b) => b.size - a.size)
                .forEach(chunk => {
                  const status = chunk.size > chunk.limit ? '‚ùå' : '‚úÖ';
                  if (chunk.size > chunk.limit) hasViolation = true;
                  console.log(\`\${status} \${chunk.name}: \${chunk.size}KB (limit: \${chunk.limit}KB)\`);
                });
              
              console.log('');
              console.log(\`Total: \${data.total}KB (limit: \${data.totalLimit}KB)\`);
              console.log('');
              
              if (data.total > data.totalLimit) {
                console.log('‚ùå Total bundle size exceeds limit');
                process.exit(1);
              } else if (hasViolation) {
                console.log('‚ùå One or more chunks exceed their size limits');
                process.exit(1);
              } else {
                console.log('‚úÖ All bundle sizes are within limits');
              }
            "
          else
            echo "‚ùå Client build directory not found"
            echo "CLIENT_SIZE=0" >> $GITHUB_ENV
            echo 'BUNDLE_JSON={"total":0,"totalLimit":2560,"chunks":[]}' >> $GITHUB_ENV
          fi
      - name: Comment bundle size on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const bundleData = JSON.parse(process.env.BUNDLE_JSON || '{"total":0,"totalLimit":2560,"chunks":[]}');
            const commentMarker = '<!-- bundle-size-report -->';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            // Sort chunks by size descending
            const sortedChunks = [...bundleData.chunks].sort((a, b) => b.size - a.size);
            
            // Build table rows
            const tableRows = sortedChunks.map(chunk => {
              const status = chunk.size > chunk.limit ? '‚ùå' : '‚úÖ';
              const percent = Math.round((chunk.size / chunk.limit) * 100);
              return `| ${chunk.name} | ${chunk.size}KB | ${chunk.limit}KB | ${percent}% | ${status} |`;
            }).join('\n');
            
            // Calculate overall status
            const hasViolation = sortedChunks.some(c => c.size > c.limit);
            const totalExceeded = bundleData.total > bundleData.totalLimit;
            const overallStatus = (hasViolation || totalExceeded) ? '‚ùå Exceeds limit' : '‚úÖ Within limit';
            
            const comment = [
              commentMarker,
              '## Bundle Size Report üì¶',
              '',
              `| Metric | Value |`,
              `|--------|-------|`,
              `| **Total Size** | ${bundleData.total}KB |`,
              `| **Total Limit** | ${bundleData.totalLimit}KB |`,
              `| **Status** | ${overallStatus} |`,
              '',
              '<details>',
              '<summary>Chunk Breakdown</summary>',
              '',
              '| Chunk | Size | Limit | Used | Status |',
              '|-------|------|-------|------|--------|',
              tableRows,
              '',
              '</details>',
              '',
              `[View workflow run](${runUrl})`
            ].join('\n');
            
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const existingComment = comments.find(c => c.body && c.body.includes(commentMarker));
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              console.log(`Updated existing comment ${existingComment.id}`);
            } else {
              const { data: newComment } = await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              console.log(`Created new comment ${newComment.id}`);
            }

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v6
      - name: Use Node.js 22.x
        uses: actions/setup-node@v6
        with:
          node-version: 22.x
      - uses: pnpm/action-setup@v4.1.0
        with:
          version: 10.27.0
          run_install: false
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      - name: Setup pnpm cache
        uses: actions/cache@v5
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      - name: Run unit tests with coverage
        run: pnpm test:coverage

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v6
      - name: Use Node.js 22.x
        uses: actions/setup-node@v6
        with:
          node-version: 22.x
      - uses: pnpm/action-setup@v4.1.0
        with:
          version: 10.27.0
          run_install: false
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      - name: Setup pnpm cache
        uses: actions/cache@v5
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      - name: Run integration tests
        env:
          CI: true
        run: pnpm test:integration:mcp-server

  agent-loop-tests:
    name: Agent Loop Integration Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v6
      - name: Use Node.js 22.x
        uses: actions/setup-node@v6
        with:
          node-version: 22.x
      - uses: pnpm/action-setup@v4.1.0
        with:
          version: 10.27.0
          run_install: false
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      - name: Setup pnpm cache
        uses: actions/cache@v5
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      - name: Run agent loop integration tests (VCR playback)
        env:
          CI: true
          VCR_MODE: playback
        run: pnpm test:integration:agent-loop

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v6
      - name: Use Node.js 22.x
        uses: actions/setup-node@v6
        with:
          node-version: 22.x
      - uses: pnpm/action-setup@v4.1.0
        with:
          version: 10.27.0
          run_install: false
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      - name: Setup pnpm cache
        uses: actions/cache@v5
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      - name: Run e2e tests
        env:
          CI: true
        run: pnpm test:e2e
