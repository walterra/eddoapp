# EDOT Collector Configuration for Kibana APM UI
# See: https://www.elastic.co/docs/reference/opentelemetry/edot-collector
#
# Required components for APM UI:
# - elasticapm processor: enriches traces for APM UI compatibility
# - spanmetrics connector: generates APM metrics from traces
#
# Usage:
#   pnpm otel:collector:start   # Start collector
#   pnpm otel:collector:stop    # Stop collector
#   pnpm otel:collector:logs    # View logs
#
# CouchDB metrics:
#   Scraped via Prometheus receiver from CouchDB's built-in /_node/_local/_prometheus endpoint
#   Requires COUCHDB_USERNAME and COUCHDB_PASSWORD environment variables

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  # CouchDB metrics via Prometheus endpoint
  # Note: Uses host.docker.internal to reach host machine from Docker on macOS
  prometheus:
    config:
      scrape_configs:
        - job_name: 'couchdb'
          scrape_interval: 30s
          static_configs:
            - targets: ['host.docker.internal:5984']
          metrics_path: '/_node/_local/_prometheus'
          basic_auth:
            username: ${env:COUCHDB_USERNAME:-admin}
            password: ${env:COUCHDB_PASSWORD:-password}

processors:
  batch:
    timeout: 5s
    send_batch_size: 1000

  # Required for Kibana APM UI - enriches traces with Elastic-specific attributes
  elasticapm: {}

connectors:
  # Required for Kibana APM UI - generates APM metrics from traces
  # (latency histograms, throughput, service maps)
  spanmetrics:

exporters:
  debug:
    verbosity: basic

  # Elasticsearch exporter with ECS mapping for APM UI compatibility
  # Uses COLLECTOR_ES_NODE (for Docker networking) separate from local ES_NODE
  elasticsearch/otel:
    endpoints: ["${env:COLLECTOR_ES_NODE}"]
    api_key: ${env:ELASTIC_API_KEY}
    mapping:
      mode: ecs  # ECS mode for Kibana APM UI compatibility
    traces_index: traces-apm-default
    tls:
      # OTEL_TLS_VERIFY=false disables verification (for self-signed certs)
      # OTEL_CA_FILE=/path/to/ca.pem provides custom CA certificate
      # Note: OTEL_TLS_SKIP_VERIFY is derived from OTEL_TLS_VERIFY in docker-compose
      insecure_skip_verify: ${env:OTEL_TLS_SKIP_VERIFY:-false}
      ca_file: ${env:OTEL_CA_FILE:-}

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch, elasticapm]
      exporters: [debug, spanmetrics, elasticsearch/otel]

    # Metrics pipeline receives:
    # - Direct metrics from OTLP
    # - Generated APM metrics from spanmetrics connector
    # - CouchDB metrics from Prometheus scraper
    metrics:
      receivers: [otlp, spanmetrics, prometheus]
      processors: [batch]
      exporters: [debug, elasticsearch/otel]

    logs:
      receivers: [otlp]
      processors: [batch]
      exporters: [debug, elasticsearch/otel]
